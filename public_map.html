<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="description" content="Peta interaktif persebaran sensor banjir SERABI. Pantau status siaga, debit air, dan lokasi rawan banjir secara real-time.">
    <meta name="theme-color" content="#0A3D52">
    <title>Peta Persebaran Sensor - SERABI</title>
    
    <link rel="preconnect" href="https://a.basemaps.cartocdn.com" crossorigin>
    <link rel="preconnect" href="https://b.basemaps.cartocdn.com" crossorigin>
    <link rel="preconnect" href="https://c.basemaps.cartocdn.com" crossorigin>
    <link rel="preconnect" href="https://d.basemaps.cartocdn.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

    <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* Variabel Warna Utama */
        :root { 
            --deep-ocean: #0A3D52; 
            --water-dark: #006064; 
        }

        /* Reset & Layout */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f0f0; }
        
        /* Map Container */
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #e3e3e3; }

        /* Navbar */
        .navbar {
            position: absolute; top: 0; left: 0; width: 100%; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 60px; display: flex; align-items: center;
        }
        .nav-container {
            width: 90%; max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--deep-ocean); text-decoration: none; letter-spacing: -0.5px; }
        .nav-links { list-style: none; display: flex; gap: 15px; padding: 0; margin: 0; }
        .nav-links a { text-decoration: none; color: #555; font-weight: 500; font-size: 0.85rem; transition: 0.3s; }
        .nav-links a:hover { color: var(--deep-ocean); }
        .lang-btn { background: var(--deep-ocean); color: white !important; padding: 8px 15px; border-radius: 50px; }
        .lang-btn:hover { background: var(--water-dark); transform: translateY(-1px); }

        /* Floating Title Card */
        .map-title-card {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%); z-index: 999;
            background: white; padding: 12px 25px; border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); text-align: center; min-width: 260px;
            animation: slideDown 0.5s ease-out; will-change: transform, opacity;
        }
        .map-title-card h2 { margin: 0; font-size: 1rem; color: var(--deep-ocean); }
        .map-title-card p { margin: 0; font-size: 0.75rem; color: #666; }

        @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }

        /* SVG Icons Helper */
        .svg-icon { width: 1em; height: 1em; vertical-align: -0.125em; fill: currentColor; display: inline-block; }

        /* Popup Styles */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        .popup-header { background: var(--deep-ocean); color: white; padding: 8px 12px; font-size: 0.85rem; font-weight: bold; display: flex; align-items: center; gap: 6px; }
        .popup-body { padding: 12px; }
        .status-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; color: white; margin-bottom: 6px; }
        .online { background: #2dce89; } .offline { background: #f5365c; }
        
        .btn-check {
            display: block; width: 100%; padding: 8px; background: var(--water-dark); color: white;
            text-align: center; text-decoration: none; border-radius: 4px; font-weight: bold; font-size: 0.8rem; box-sizing: border-box; margin-top: 5px;
        }
        .btn-check:hover { background: #004d40; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">SERABI</a>
            <ul class="nav-links">
                <li><a href="index.html">Kembali</a></li>
                <li><a href="login.html" class="lang-btn">Login Petugas</a></li>
            </ul>
        </div>
    </nav>

    <div class="map-title-card">
        <h2>Pilih Lokasi Pantau</h2>
        <p>Klik pin pada peta untuk melihat detail.</p>
    </div>

    <div id="map"></div>

    <script type="module">
        import { supabase } from './js/supabase.js';

        // Icon Pin SVG (Sangat ringan, tidak perlu download font/gambar)
        const pinIconSVG = `<svg class="svg-icon" viewBox="0 0 384 512" style="width:14px;height:14px"><path d="M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0zM192 272c44.183 0 80-35.817 80-80s-35.817-80-80-80-80 35.817-80 80 35.817 80 80 80z"/></svg>`;

        function initMap() {
            // Mekanisme Retry: Tunggu Leaflet siap karena script di-defer
            if (typeof L === 'undefined') {
                setTimeout(initMap, 50);
                return;
            }

            const map = L.map('map', {
                zoomControl: false,
                fadeAnimation: true,
                markerZoomAnimation: true
            }).setView([-6.97197, 107.62969], 13);

            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Menggunakan CartoDB Voyager (Sangat Cepat & Ringan)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19,
                crossOrigin: true 
            }).addTo(map);

            loadDevices(map);
        }

        async function loadDevices(map) {
            try {
                // Optimasi: Hanya ambil kolom yang dibutuhkan
                const { data: devices, error } = await supabase
                    .from('devices')
                    .select('id, name, status, location_lat, location_lng');
                
                if (error) throw error;
                if (!devices) return;

                devices.forEach(dev => {
                    const isOnline = dev.status === 'online';
                    const statusClass = isOnline ? 'online' : 'offline';
                    
                    const popupHTML = `
                        <div class="popup-header">
                            ${pinIconSVG} <span>${dev.name}</span>
                        </div>
                        <div class="popup-body">
                            <span class="status-badge ${statusClass}">${dev.status.toUpperCase()}</span>
                            <div style="font-size:0.75rem; color:#666; margin-bottom:8px;">
                                ${dev.location_lat.toFixed(4)}, ${dev.location_lng.toFixed(4)}
                            </div>
                            <a href="home_public.html?id=${dev.id}" class="btn-check">Cek Status</a>
                        </div>
                    `;

                    L.marker([dev.location_lat, dev.location_lng])
                        .addTo(map)
                        .bindPopup(popupHTML, { className: 'custom-popup' });
                });

            } catch (err) {
                console.error("Map Error:", err);
            }
        }

        initMap();
    </script>
</body>
</html>